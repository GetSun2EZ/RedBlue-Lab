# Ce fichier a but pour de donner la solution du TP 'Red_Log4Shell'
# Les adresse IP ne sont pas forcément identiques.
# Cette solution sera en 4 parties :
## Partie   I : Reconnaissance
`$ sudo nmap -sP 192.168.160.0/24`
```
Starting Nmap 7.91 ( https://nmap.org ) at 2022-07-02 18:57 CEST
MAC Address: 00:50:56:C0:00:08 (VMware)
Nmap scan report for 192.168.160.2
Host is up (0.00043s latency).
MAC Address: 00:50:56:EB:76:AD (VMware)
Nmap scan report for 192.168.160.205
Host is up (0.0012s latency).
MAC Address: 00:50:56:F6:D4:70 (VMware)
Nmap scan report for 192.168.160.128
Host is up.
Nmap done: 256 IP addresses (3 hosts up) scanned in 2.17 seconds
```

`$ sudo nmap -sS -sV -p- 192.168.160.205`
```
Starting Nmap 7.91 ( https://nmap.org ) at 2022-07-02 19:00 CEST
Nmap scan report for 192.168.160.205
Host is up (0.00079s latency).
Not shown: 65515 filtered ports
PORT      STATE SERVICE      VERSION
53/tcp    open  domain       Simple DNS Plus
88/tcp    open  kerberos-sec Microsoft Windows Kerberos (server time: 2022-07-02 17:02:27Z)
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
389/tcp   open  ldap         Microsoft Windows Active Directory LDAP (Domain: RedBlue.lab, Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds (workgroup: RBLAB)
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP (Domain: RedBlue.lab, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
9389/tcp  open  mc-nmf       .NET Message Framing
49666/tcp open  msrpc        Microsoft Windows RPC
49667/tcp open  msrpc        Microsoft Windows RPC
49669/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
49670/tcp open  msrpc        Microsoft Windows RPC
49671/tcp open  msrpc        Microsoft Windows RPC
49682/tcp open  msrpc        Microsoft Windows RPC
49694/tcp open  msrpc        Microsoft Windows RPC
MAC Address: 00:0C:29:DF:90:AC (VMware)
Service Info: Host: WIN-KSJNGF0GUAR; OS: Windows; CPE: cpe:/o:microsoft:windows
 
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 161.24 seconds
```

## Partie   II : Exploration
Nous remarquons qu’il s’agit d’un serveur Windows, nous récupérons quelques informations comme le domaine, le workgroup et le nom d’hôte.
Malheureusement, il n’y a pas plus d’informations, et tous les services exécutés sont des services normaux à Windows. Il va donc falloir tous les tester afin de vérifier si un des services n’est pas vulnérable.
Ici, le nom du défi nous permet de savoir que c’est la vulnérabilité ZeroLogon qui peut être exploitable.

Commençons donc par réaliser un programme python pour déterminer si l’attaque est possible. Pour ce faire, il faut tester s’il est possible de s’authentifier sans le mot de passe.
L’outil impacket peut se révéler très utile et la documentation Microsoft aussi.
Pour s’authentifier deux fonctions Microsoft sont utilisées, la première est NetrServerReqChallenge et la deuxième est NetrServerAuthenticate3.

Pour installer impacket, exécuter les commandes suivantes :
```
python3 -m pip install virtualenv
python3 -m virtualenv impacketEnv
source impacketEnv/bin/activate
pip install git+https://github.com/SecureAuthCorp/impacket
```
Puis exécuter le programme 'script_detection_zerologon.py'

En exécutant ce programme, on détermine que l’attaque ZeroLogon est réalisable.

## Partie   IV : Exploitation
Procédons maintenant à l’authentification puis au changement de mot de passe.
Les deux fonctions précédentes sont nécessaires mais il faut ajouter la fonction NetrServerPasswordSet2.

Puis exécuter le programme 'exploitation_zerologon.py'

En exécutant ce programme, le mot de passe du compte WIN-KSJNGF0GUAR$, donc le compte machine, est nul.
Il est maintenant possible d’utiliser le programme "secretdump.py" fourni par l’outil impacket. <br>
`$ python3 impacketEnv/bin/secretsdump.py -no-pass -just-dc WIN-KSJNGF0GUAR\$@192.168.160.205`

![Capture d'écran de la sortie de secretdump.py](https://github.com/GetSun2EZ/RedBlue-Lab/blob/main/Images/secretdump_output.png)

On récupère le condensat du compte Administrateur. Avec celui-ci, on se connecte à la machine distante avec le programme vmiexec.py fournit par "impacket". On obtient alors le drapeau administrateur qui se trouve à la racine. <br>
![Capture d'écran de la connexion WinRM](https://github.com/GetSun2EZ/RedBlue-Lab/blob/main/Images/connexion_winrm.png)

## Partie   V : Post-Exploitation
Il faut maintenant remettre l’ancien mot de passe du compte machine. Pour cela, si on exécute le programme "secretdump.py" avec le compte Administrateur, on obtient aussi les condensats LSA où se trouve l’ancien mot de passe du compte machine. <br>
![Capture d'écran de la sortie de secretdump.py](https://github.com/GetSun2EZ/RedBlue-Lab/blob/main/Images/ancien_mot_de_passe.png)

Pour créer un programme python qui remet l’ancien mot de passe, il sera encore une fois nécessaire d’utiliser les fonctions "NetrServerReqChallenge" et la deuxième est "NetrServerAuthenticate3". Et la dernière fonction nécessaire est "NetrServerPasswordSet" mais elle n’est pas définie dans l’outil "impacket", il va donc falloir la créer.

Puis exécuter le programme 'retablissement_password.py'

Pour vérifier si le mot de passe a été remis correctement, il est possible de relancer le programme "secretdump.py" avec le compte Administrateur.
